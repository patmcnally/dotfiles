#!/bin/bash

# Description:
#
#	Makes the deploy instructions for this repo + branch.
#
#	- Copies to clipboard.
#	- Updates the jira ticket, if kathy-cli exists.

# Synopsis:
#
#	git-deploy <ticket>
#
#	- You may supply a ticket as the first arg, to override where in jira to update.

repo=$(git rev-parse --show-toplevel);
repo="${repo/\/Volumes\/CODE\//}";
repo="${repo/\/var\/www\/html\/announcemedia\//}";
branch=`git rev-parse --abbrev-ref HEAD`;
if [ "$branch" == "HEAD" ]; then
	echo "EXIT: You are not on a branch";
	exit 1;
fi;

if [ "$#" -ge 1 ]; then
	ticket=$1;
else
	ticket=$branch;
fi;

deploy="# $(basename "$repo") (branch: $branch)";
nl="
";
if [ ${repo:0:15} == "sql_deployments" ]; then
	deploy="$deploy${nl}cd /var/www/html/announcemedia/$repo;${nl}sudo gitsqldeploy $(git rev-parse HEAD);";
elif [ ${repo} == "server_configs" ]; then
	deploy="$deploy${nl}cd /var/www/html/announcemedia/$repo;${nl}sudo gitswitch $(git rev-parse HEAD);${nl}# restart apache${nl}sudo /etc/init.d/httpd reload;";
else
	deploy="$deploy${nl}cd /var/www/html/announcemedia/$repo;${nl}sudo gitswitch $(git rev-parse HEAD);";
fi;

#echo "DBG :: ticket: $ticket branch: $branch; repo: $repo; deploy: $deploy";

echo "$deploy" | pbcopy;
echo "Copied deploy instructions to clipboard";

if hash kathy-cli 2>/dev/null ; then
	#echo "EXEC: kathy-cli jira instrs $ticket $repo \$deploy";
	echo "$deploy" | kathy-cli jira instrs $ticket $repo;
else
	echo "Unable to find kathy-cli; I can update the ticket for you if provided."
fi
